<html>
<head>
  <title>DeviceMotion Test</title>
  <style>
  #videoid{
    width : 70vw ;
    height : 70vh ;
  }
  .directring{
    position: relative;

  }
  .video_part{
    position: absolute;
    top: 0;
    left: 0;
  }
  </style>
</head>
<body>
  <div class="directring">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/pWVGiSZd1K8" id = "videoid" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    <div class="sairiumu">
      <img src="https://1.bp.blogspot.com/-DD0J8DE44Ew/VXOULxJvZiI/AAAAAAAAuHw/F7MmGW-8NWs/s800/cyalume_light5_orange.png">
    </div>
  </div>
  <form id="url-setting">
    <input type="text" id="vd">
    <button>YouTubeURLを入力</button>
  </form>
  <form id="name-setting">
    <input type="text" id="nm">
    <button>名前を設定</button>
  </form>
  <div><button onClick="deviceMotionRequest_test()">加速度測定Click</button><br></div>
  <div id="test_acc"></div>
  <div><button onClick="deviceMotionRequest()">サイリウムClick</button><br></div>
  <p id="Terminal"></p>


  <div id="result_acc"></div>
  <br />
  <div id="result_gyro"></div>
  <br />
  <div id="shake_count"></div>
  <ul id="shake_list"></ul>
  <script src="/socket.io/socket.io.js"></script>
  <script>

  const socket = io();
  var normal_cnt = 0;
  var kecak_cnt = 0;
  var m_cnt = 0;
  var pick = 0;
  var bool = 0;
  var max = 50.00;
  var tmax = 0;
  var m = 0;
  var array_x = new Array(60);
  var array_y = new Array(60);
  var array_z = new Array(60);
  var name = "";
  var url_id =  "";

  var ta = document.getElementById('Terminal')
  var msg = "使用機種:"
  var ut = navigator.userAgent;


  document.querySelector("#url-setting").addEventListener("submit", (e)=>{
    // 規定の送信処理をキャンセル(画面遷移しないなど)
    e.preventDefault();

    if( vd.value === "" ){
      return(false);
    }
    url_id = document.querySelector("vd");
    var video_url = document.getElementById('videoid');
    if (!video_url){ return false;}
    console.log('https://www.youtube.com/embed/' + vd.value)
    video_url.setAttribute('src', 'https://www.youtube.com/embed/' + vd.value);
  });

  document.querySelector("#name-setting").addEventListener("submit", (e)=>{
    // 規定の送信処理をキャンセル(画面遷移しないなど)
    e.preventDefault();

    // 入力内容を取得する
    name = document.querySelector("nm");
    if( nm.value === "" ){
      return(false);
    }
  });

  if(ut.indexOf('iPhone') > 0 || ut.indexOf('iPod') > 0 || ut.indexOf('iPad') > 0){
    msg+=":ios";
  }else if(ut.indexOf('Android') > 0 ||ut.indexOf('Android') > 0 && ut.indexOf('Mobile') > 0){
    msg+="android";
  }else{
    msg+="PC";
  }

  ta.textContent = msg;

  var s = new String("");
  var name_s = new String("");
  var shake_judge_bool = 0;
  function deviceMotionRequest_test () {
    if (DeviceMotionEvent.requestPermission) {
      DeviceMotionEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          window.addEventListener( "devicemotion", function( event ){
            var tx = event.accelerationIncludingGravity.x;
            var ty = event.accelerationIncludingGravity.y;
            var tz = event.accelerationIncludingGravity.z;

            if(msg.indexOf('ios')>0){
              if(tmax > tx){
                tmax = tx;
              }
            }else{
              if(tmax < tx){
                tmax = tx;
              }
            }
            var test1 = document.getElementById( "test_acc" );
            test1.innerHTML = "重力加速度<br />" +
            "X：" + tx.toFixed(2) +"(m/s^2)<br />" +
            "Y：" + ty.toFixed(2) +"(m/s^2)<br />" +
            "Z：" + tz.toFixed(2) +"(m/s^2)<br /><br />" +
            "tmax：" + tmax+"<br />" ;

          });
        }
      })
    }else{
      window.addEventListener( "devicemotion", function( event ){
        var tx = event.accelerationIncludingGravity.x;
        var ty = event.accelerationIncludingGravity.y;
        var tz = event.accelerationIncludingGravity.z;

        if(msg.indexOf('ios')>0){
          if(tmax > tx){
            tmax = tx;
          }
        }else{
          if(tmax < tx){
            tmax = tx;
          }
        }

        var test1 = document.getElementById( "test_acc" );
        test1.innerHTML = "重力加速度<br />" +
        "X：" + tx +"(m/s^2)<br />" +
        "Y：" + ty +"(m/s^2)<br />" +
        "Z：" + tz +"(m/s^2)<br /><br />" +
        "tmax：" + tmax+"<br />" ;
      });
    }
  }
  function deviceMotionRequest () {
    if (DeviceMotionEvent.requestPermission) {
      DeviceMotionEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          window.addEventListener( "devicemotion", function( event ){
            var x = event.accelerationIncludingGravity.x;
            var y = event.accelerationIncludingGravity.y;
            var z = event.accelerationIncludingGravity.z;
            array_x[m_cnt%60] = x;
            array_y[m_cnt%60] = y;
            array_z[m_cnt%60] = z;

            m_cnt ++;
            max = Math.abs(tmax) * 0.75;
            if(Math.abs(x) > max && bool == 0){
              normal_cnt ++;
              socket.emit("shake",nm.value);
              if(x > max){
                s += "+";
              }else if(x < -max){
                s += "-";
              }
              bool = 1;
            }

            if(Math.abs(x) <= max && bool == 1){
              bool = 0;
            }
            socket.on("member-shake", (nm)=>{
              const ul = document.getElementById('shake_list');
              const li = document.createElement("li");
              const text = document.createTextNode(nm + "が振った！");
              li.appendChild(text);
              ul.appendChild(li);
            });

            var result1 = document.getElementById( "result_acc" );
            result1.innerHTML = "重力加速度<br />" +
            "X：" + x.toFixed(2) +"(m/s^2)<br />" +
            "Y：" + y.toFixed(2) +"(m/s^2)<br />" +
            "Z：" + z.toFixed(2) +"(m/s^2)<br /><br />" +
            "max：" + max+"<br />" +
            "振った回数(normal): " + normal_cnt +"回"+"!"+s+"!<br />" +
            "振った回数(kecak): " + kecak_cnt +"回"+"<br />" +
            "更新回数:" + pick;
          });


          window.addEventListener( "deviceorientation", function( event ) {
            var alpha = event.alpha;
            var beta = event.beta;
            var gamma = event.gamma;

            var result2 = document.getElementById( "result_gyro" );
            result2.innerHTML = "ジャイロセンサー<br />" +
            "alpha：" + alpha.toFixed(2) +"°<br />" +
            "beta ：" + beta.toFixed(2)  +"°<br />" +
            "gamma：" + gamma.toFixed(2) +"°<br />";
          }, false)
        }
      })
      .catch(console.error);
    } else {
      window.addEventListener( "devicemotion", function( event ){
        var x = event.accelerationIncludingGravity.x;
        var y = event.accelerationIncludingGravity.y;
        var z = event.accelerationIncludingGravity.z;
        array_x[m_cnt%60] = x;
        array_y[m_cnt%60] = y;
        array_z[m_cnt%60] = z;
        m_cnt ++;
        max = Math.abs(tmax) * 0.75;
        if(Math.abs(x) > max && bool == 0){
          normal_cnt ++;
          socket.emit("shake",nm.value);
          if(x > max){
            s += "+";
          }else if(x < -max){
            s += "-";
          }
          bool = 1;
        }


        if(Math.abs(x) <= max && bool == 1){
          bool = 0;
        }

        socket.on("member-shake", (nm)=>{
          const ul = document.getElementById('shake_list');
          const li = document.createElement("li");
          const text = document.createTextNode(nm + "が振った！");
          li.appendChild(text);
          ul.appendChild(li);
        });


        var result1 = document.getElementById( "result_acc" );
        result1.innerHTML = "重力加速度<br />" +
        "X：" + x +"(m/s^2)<br />" +
        "Y：" + y+"(m/s^2)<br />" +
        "Z：" + z +"(m/s^2)<br /><br />" +
        "振った回数: " + normal_cnt +"回"+"!"+s+"!<br />" +
        "更新回数:" + pick;
      });
    }
  }

  </script>
</body>
</html>
